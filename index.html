<!doctype html>
<html lang="ru">
<head>
	<title>Поиск на стене вконтакте</title>
    <script src="http://vk.com/js/api/openapi.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<link rel="stylesheet" href="http://swey.biz/css/style.css"/>
	<link href="/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body>
	<section style="margin-top: 20px;">
		<div class="container">
			<div class="row">
				<div class="col-md-6">
					<div class="input-group">
					</div>
					<div id="error"></div>
					<div class="contacts-widget" style="margin-top: 20px;">
						<div class="widget-body 300-scroll">
							<ul class="list-unstyled">
								<li class="contact-alpha">
									Где будем искать?
									<div class="clearfix"></div>
								</li>
							</ul>
							<ul class="list-unstyled" id="profiles">
								<div class="errorL" id="errorL">Укажите профиль пользователя или сообщесва!</div>
							</ul>
						</div>
						<div class="widget-foot"></div>
					</div>
				</div>	
				<div class="col-md-6">
					<div class="input-group">
						<span class="input-group-btn">
							<button type="submit" class="btn btn-info" onclick="query();"><span class="glyphicon glyphicon-search"></span></button>
						</span>
					</div>
					<div class="contacts-widget" style="margin-top: 20px;">
						<div class="widget-body">
							<ul class="list-unstyled">
								<li class="contact-alpha">
									Найденные записи. <span class="label label-info pull-right"><span id="resultCount">0</span> Найденных записей</span>
									<div class="clearfix"></div>
								</li>
								<ul class="list-unstyled" id="result">
									
								</ul>
							</ul>
						</div>
						<div class="widget-foot"></div>
					</div>
				</div>		
			</div>
		</div>
	</section>
    <script>
VK.init({
    apiId: 5322127
});
var membersGroups = []; // массив участников группы
getMembers(30666517);

// получаем информацию о группе и её участников
function getMembers(group_id) {
	VK.Api.call('groups.getById', {group_id: group_id, fields: 'photo_50,members_count', v: '5.27'}, function(r) {
			if(r.response) {
				$('.group_info')
				.html('<img src="' + r.response[0].photo_50 + '"/><br/>' 
					+ r.response[0].name
					+ '<br/>Участников: ' + r.response[0].members_count);
				getMembers20k(group_id, r.response[0].members_count); // получаем участников группы и пишем в массив membersGroups
			}
	});
}

// получаем участников группы, members_count - количество участников
function getMembers20k(group_id, members_count) {
	var code =  'var members = API.wall.get({"group_id": ' + group_id + ', "v": "5.27", "offset": ' + membersGroups.length + '}).items;' // делаем первый запрос и создаем массив
			+	'var offset = 100;' // это сдвиг по участникам группы
			+	'while (offset < 25000 && (offset + ' + membersGroups.length + ') < ' + members_count + ')' // пока не получили 20000 и не прошлись по всем участникам
			+	'{'
				+	'members = members + "," + API.wall.get({"group_id": ' + group_id + ', "v": "5.27", "count": "100", "offset": (' + membersGroups.length + ' + offset)}).items;' // сдвиг участников на offset + мощность массива
				+	'offset = offset + 100;' // увеличиваем сдвиг на 1000
			+	'};'
			+	'return members;'; // вернуть массив members
	
	VK.Api.call("execute", {code: code}, function(data) {
		if (data.response) {
			membersGroups = membersGroups.concat(JSON.parse("[" + data.response + "]")); // запишем это в массив
			$('.member_ids').append('Загрузка: ' + membersGroups.length);
			if (members_count >  membersGroups.length) // если еще не всех участников получили
				setTimeout(function() { getMembers20k(group_id, members_count); }, 333); // задержка 0.333 с. после чего запустим еще раз
			else // если конец то
				alert('Ура тест закончен! В массиве membersGroups теперь ' + membersGroups.length + ' элементов.');
		} else {
			alert(data.error.error_msg); // в случае ошибки выведем её
		}
	});
}
	</script>
    </body>
</html>
