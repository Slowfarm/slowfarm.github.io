<!doctype html>
<html lang="ru">
	<style>
		#myProgress {
		  position: relative;
		  width: 100%;
		  height: 30px;
		  background-color: #ddd;
		}
		
		#myBar {
		  position: absolute;
		  width: 0%;
		  height: 100%;
		  background-color: #4CAF50;
		}
		
		#label {
		  text-align: center;
		  line-height: 30px;
		  color: white;
		}
	</style>
	<head>
		<title>Посты пользователя vk</title>
		<script src="//vk.com/js/api/openapi.js?117" type="text/javascript"></script>
		<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	</head>
	<body>
		<input type="text" class="form-control" id="inputUser" placeholder="Введите id пользователя">
		<input type="text" class="form-control" id="inputGroups" placeholder="Введите id сообществ">
		<input type="button" value="Найти" onclick="login();">
		<input type="button" value="Войти" onclick="oAuth();">
		<div id="wallInfo"></div>
		<div id="myProgress">
		<div id="myBar">
			<div id="label">0%</div>
			</div>
		</div>
		<div id="wall"></div>
		
		<script type="text/javascript">
			VK.init({
  			apiId: 5322127
			});
			
			var wallInfoStream = document.getElementById('wallInfo');
			var wallStream = document.getElementById('wall');
			var separator = "<br/>-----------------------<br/>";
			var user_id;
			var int_user_id;
			var groups;
			var groups_id;
			var index = 0;
			var access = false;
			var groups_count = 0;
			var offset;
			
			function oAuth(){
				document.location.href = "https://oauth.vk.com/authorize?client_id=5322127&display=page&redirect_uri=http://slowfarm.github.io&scope=groups&response_type=code&v=5.50";
			}
			
			function login(){
			var tmp = new Array();
 			var param = new Array();
 			var get = location.search;  // строка GET запроса
 				if(get != '') {
 					tmp = (get.substr(1)).split('&');   // разделяем переменные
 					tmp = tmp[0].split('=');       // массив param будет содержать
 					param[tmp[0]] = tmp[1];       // пары ключ(имя переменной)->значение
 					}
 			if(param["code"])
 				access=true;
			if(access){
				wallInfoStream.innerHTML = "";
				wallStream.innerHTML = "";
				move(0);
				user_id = document.getElementById('inputUser').value;// получение id пользователя
				groups = document.getElementById('inputGroups').value;// получение списка сообществ
				groups_id = groups.split(',');
				groups_count = groups_id.length;
				if (user_id.indexOf("com/") >= 0)
					user_id = user_id.split('com/')[1];
				//получение запроса на целочисленный id пользователя, имя и изображение
				VK.Api.call('users.get', {user_ids: user_id, fields: 'photo_max', v: '5.27'}, function(r) {
	           			if(r.response) {
	       				wallInfoStream.innerHTML += '<a href="#"><img src="' + r.response[0].photo_max + '" alt="" class="img-responsive"/></a>';
	       				wallInfoStream.innerHTML += "<br/>"+r.response[0].first_name+"<br/>"+r.response[0].last_name+separator;
	            			user_id = r.response[0].id;
	            			int_user_id = parseInt(user_id, 10);
	            			main();
	            			}
	            			else {
						alert("Неверный идентификатор пользователя. Error: '"+r.error.error_msg+"'");
					}
				});
				}
			else {
				alert("Прежде чем использовать модуль нажмите Войти");
			}
			}
			
			function main() { // получаем список id сообществ
				if(index < groups_count) {
					var owner_id = "-"+groups_id[index];
					delay(500);
					index++;
					offset = 0;
					move(index/groups_count*100);
					getGroups(owner_id);
				}
				else {
					index=0;
					//alert("complete");
				}
			}
			
			function getGroups(owner_id) { // получаем колличество постов вгруппе
				var code = 'return API.wall.get({owner_id: '+ owner_id +', count: 1, v: 5.37});';
				VK.Api.call('execute', {code: code, v: '5.37'}, function(r) {
					if(r.response) {
						wallSearch(owner_id ,r.response.count);
					}
						else {
							alert("Доступ к сообществу "+owner_id+" ограничен. Error: "+r.error.error_msg +"'");
							main();
						}
					});
			 }
			 
			function wallSearch(group_id, dataCount) {// записей пользователя по сообществу
				delay(334);
				var code='var j=0;'
					+'var i=0;'
					+'var offset='+offset+';'
					+'var output = null;'
					+'var result;'
					+'var separator = "<br/>------------<br/>";'
					+'while (j<5) {'
					+'var posts = API.wall.get({"owner_id": '+ group_id +', "v": "5.27", "count": "100", "offset": offset}).items;'
					+    'j = j+1;'
					+   'while (i<100) {'
					+        'if(posts[i].from_id == ' + int_user_id + ')'
					+            'output = output+posts[i].text+separator;'
					+	 'if(posts[i].signer_id == ' + int_user_id + ')'
					+	     'output = output+posts[i].text+separator;'
					+        'i=i+1;'
					+    '}'
					+    'i=0;'
					+    'offset = offset+100;'
					+'}'
					+'return output;'
					
				VK.Api.call('execute', {code: code, v: '5.37'}, function(data){
					  if (data.response) {
					  		wallStream.innerHTML+=" "+data.response+separator;
							offset+=500;
							wallSearch(group_id, dataCount);
						}
					  else {
					  	main();
					  	//alert(data.error.error_msg + " WallSearch()");
					  }
				});
			}
						function delay(ms) { // создаем задержку
			      ms = parseInt(ms); 
			      if (ms <= 0) return; 
			      var before = after = new Date(); 
			      before = before.getTime(); 
			      after = after.getTime(); 
			      while (after < before + ms) { 
			            after = new Date(); 
			            after = after.getTime(); 
			      } 
			}
			function move(width) { // функция смещения progress bar
				var elem = document.getElementById("myBar");   
				elem.style.width = width + '%'; 
				document.getElementById("label").innerHTML = Math.round(width) * 1  + '%';
			}
		</script>
	</body>
</html>
